# Refresh token, OAuth

## Refresh Token 방식

- 가장 많이 쓰이는 방식
- 로그인 시 Access token, Refresh token 을 모두 발급한 후 Access token 이 만료되면 Refresh token 인증 후에 재발급
- fetchClient 공통함수(또는 axiosClient)에서 status 401 => error.message 로 조건 판단 후(invalid access token 메시지) Access token 을 요청하는 함수 실행
- 이때 Refresh token 이 로컬스토리지에 저장되어 있는지, 쿠키에 저장되어 있는지 여부에 따라 적절한 방식으로 서버에 전달

### 취약점 대비

- Access token 이 만료된 시점에 CSRF 공격이 들어오는 경우
- Access token 이 살아있는 시점에서 탈취 및 악용되는 경우
- Refresh token 이 탈취되는 경우

## OAuth

- Open Authorization
- 허가된 다른 서비스를 통해 기존 서비스의 권한을 위임하는 것

1. OAuth 인증 요청
2. 타 서비스: 사용자에게 OAuth 로그인용 링크 전달, 리디렉션
   - 원본 서비스 계정으로 이런 저런 동작을 하고 싶다 ==> 링크의 query parameter 에 정의됨
3. 사용자가 원본 서비스에 인증 요청 및 타 서비스의 정보 전달
4. 원본 서비스는 사용자에게 타 서비스 전용 임시 토큰(비밀번호)과 타 서비스 링크 a를 전달
5. 사용자는 임시 토큰을 가지고 타 서비스 링크 a 방문
   - 타 서비스: 사용자 A가 임시 토큰을 가지고 링크 a에 접근했는데 허용할까? - 서비스 이름, 임시 토큰, 시크릿 키
   - 원본 서비스: 서비스 공급자, 임시 토큰, 시크릿 키, 유저 이름, 접근한 페이지 정보 전부 올바를 때 동작 승인
6. 타 서비스에서 동작 수행 및 사용자에게 응답
7. 인증 성공
   - 권한에 따라 원본 서버의 유저 정보, 권한을 위임받은 동작, 또는 인증 자체만을 사용할 수 있음

## 데이터 관리: 싱글톤 패턴

- 프론트엔드에서는 객체를 잘 다루지 않는다. 하지만...
- 하나의 데이터가 여러 용도로 분화
- 섞이지 않는 데이터, 데이터의 원천을 하나로 유지:  
  하나의 데이터가 하나의 맥락에서 관리되고 있는가?  
  만약 그렇지 않은 상태에서 API 호출까지 겹칠 경우 매우 복잡해진다.

## 기타

- 쿠키를 Header 에 넣는 방식은 탈취 및 조작 가능성이 높아진다.
- 여러 요청을 한번에 시도할 경우, 하나의 요청이 재시도 중에는 다른 요청들은 대기하도록 한다.

### 정보 저장

- 유저의 개인정보는 보안 이슈가 있으므로 클라이언트에 저장하지 않는다.
- 스토리지, 쿠키, 메모리 변수 전부 안된다, 매 서버 요청으로 가져와야만 한다.
- 클라이언트가 저장해서는 안되는 정보인지 판단이 어려울 때는 개인정보 보호법을 확인한다.

### Server Validation 은 필수

- 클라이언트는 브라우저에서 코드가 노출된다:  
  클라이언트 validation 을 뚫고 값을 쉽게 조작할 수 있다.
- 클라이언트에서 방어하더라도 비정상적인 request 를 날릴 수 있다:  
  따라서 악의적인 접근은 서버에서 방어해야 한다.
- 클라이언트와 서버 모두 권한에 따라 동작을 제한하고, 본인의 자원에만 접근할 수 있도록 만들어져야 한다.

### 로그아웃: 세션과 토큰 차이

- 세션 기반 로그인은 로그아웃을 하더라도 서버에서만 destroy 될 뿐, 클라이언트에서의 쿠키는 사라지지 않는다.  
  (의미없는 쿠키가 되어 만료될 때까지 사라지지 않는다. JS로 삭제 불가)
- 토큰 기반 로그인일 경우, 로그아웃 시 서버에서는 별도의 DB table 에 로그아웃한 토큰을 기록한다.

### 주요 상태 코드

- 200: OK
- 201: Created (요청이 성공했고, 서버에 새로운 리소스가 생성됨)
- 400: Bad Request
- 401: Unauthorized (사용자 식별 X. 로그인 되지 않았거나 세션 또는 토큰이 만료되었을 때)
- 403: Forbidden (사용자 식별 O, 권한 없음)
- 404: Not Found
